{
  "meta": {
    "project": "Sistema de Investigaciones Vehiculares",
    "date": "2025-12-30",
    "prepared_by": "Generated by Software Development Manager"
  },
  "product_overview": "Sistema backend para la gestión integral de investigaciones vehiculares para estudios jurídicos (buffets), facilitando el seguimiento de oficios, propietarios, direcciones y visitas, con integración externa para obtener información vehicular y personal.",
  "core_goals": [
    "Proveer una autenticación segura y eficiente para todos los usuarios del sistema mediante JWT.",
    "Permitir la gestión completa de buffets, con control de permisos para administradores.",
    "Facilitar la administración y seguimiento detallado de oficios de investigación vehicular.",
    "Registrar y reportar visitas de verificación realizadas por investigadores en terreno.",
    "Mantener un timeline dinámico para documentar actividades y avistamientos asociados a cada investigación.",
    "Integrar consultas externas mediante la API Boostr para enriquecer la información de vehículos y propietarios.",
    "Garantizar seguridad, confiabilidad y escalabilidad mediante prácticas robustas y requisitos no funcionales definidos."
  ],
  "key_features": [
    "Sistema de Autenticación con registro, login y obtención del usuario actual via JWT.",
    "CRUD para Administración de Buffets, accesible solo por usuarios con rol admin, incluyendo paginación y soft delete.",
    "Gestión avanzada de Oficios con filtros por estado, buffet e investigador, incluyendo vehículos, propietarios, direcciones y asignación de investigadores.",
    "Registro detallado de visitas a direcciones vinculadas a oficios con resultados categorizados y manejo del estado de verificación.",
    "Timeline de investigaciones que incluye registro de actividades y avistamientos vehiculares para seguimiento histórico.",
    "Integración con API Boostr para consulta de datos vehiculares, multas y personas basadas en la matrícula o RUT, con funciones para investigación completa.",
    "Control de acceso y permisos de vista dependiendo del rol (admin, investigador, cliente).",
    "Requisitos no funcionales que incluyen autenticación segura con expiración, manejo de rate limits, logging y configuración CORS."
  ],
  "user_flow_summary": [
    "El usuario accede al sistema mediante autenticación JWT tras registrarse o iniciar sesión.",
    "El administrador gestiona buffets creando, actualizando o eliminando registros.",
    "Investigadores y clientes consultan oficios filtrando por estado, buffet o investigador, con acceso restringido según rol.",
    "Para cada oficio, usuarios autorizados pueden agregar y modificar vehículos, propietarios y direcciones.",
    "Investigadores registran visitas a direcciones con resultados de verificación, afectando el estado del oficio y dirección.",
    "Actividades y avistamientos se agregan a la línea de tiempo para seguimiento detallado de la investigación.",
    "Usuarios acceden a consultas externas a través de la integración con Boostr para obtener información complementaria de vehículos y personas.",
    "El sistema asegura la correcta autorización y manejo de datos sensible en cada paso para cumplir con permisos definidos."
  ],
  "validation_criteria": [
    "Los usuarios deben autenticarse correctamente y recibir tokens JWT válidos con expiración configurada.",
    "Solo administradores pueden realizar operaciones de creación, actualización y eliminación en buffets.",
    "Las búsquedas y listados de oficios deben responder correctamente a filtros y paginación solicitada.",
    "El registro de visitas debe reflejarse inmediatamente en el estado de las direcciones y las respuestas deben respetar los códigos HTTP esperados.",
    "El timeline de investigaciones debe listar y permitir agregar actividades y avistamientos correctamente vinculados al oficio correspondiente.",
    "Las consultas a la API Boostr deben respetar el límite de requests y retornar respuestas adecuadas de error en caso de exceder límites o datos incorrectos.",
    "Se debe aplicar soft delete en buffets para no perder información histórica.",
    "Los roles y permisos deben ser estrictamente respetados en todas las acciones para mantener la seguridad de la información.",
    "Contar con logs completos para operaciones críticas y mantener configuración CORS para seguridad y acceso desde frontend autorizado."
  ],
  "code_summary": {
    "tech_stack": [
      "Python 3.11",
      "FastAPI",
      "SQLAlchemy 2.0",
      "PostgreSQL",
      "Pydantic v2",
      "Alembic",
      "JWT Authentication",
      "httpx"
    ],
    "features": [
      {
        "name": "Authentication",
        "description": "User authentication with JWT tokens. Supports login, register, and get current user.",
        "files": [
          "src/modules/usuarios/presentation/routers/auth_router.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "paths": {
            "/api/v1/auth/register": {
              "post": {
                "summary": "Register new user",
                "requestBody": {
                  "content": {
                    "application/json": {
                      "schema": {
                        "type": "object",
                        "required": [
                          "email",
                          "password",
                          "nombre"
                        ],
                        "properties": {
                          "email": {
                            "type": "string",
                            "format": "email"
                          },
                          "password": {
                            "type": "string",
                            "minLength": 6
                          },
                          "nombre": {
                            "type": "string"
                          },
                          "rol": {
                            "type": "string",
                            "enum": [
                              "admin",
                              "investigador",
                              "cliente"
                            ]
                          }
                        }
                      }
                    }
                  }
                },
                "responses": {
                  "201": {
                    "description": "User created successfully"
                  },
                  "400": {
                    "description": "Email already registered"
                  }
                }
              }
            },
            "/api/v1/auth/login": {
              "post": {
                "summary": "Login user",
                "requestBody": {
                  "content": {
                    "application/json": {
                      "schema": {
                        "type": "object",
                        "required": [
                          "email",
                          "password"
                        ],
                        "properties": {
                          "email": {
                            "type": "string"
                          },
                          "password": {
                            "type": "string"
                          }
                        }
                      }
                    }
                  }
                },
                "responses": {
                  "200": {
                    "description": "Login successful, returns JWT token"
                  },
                  "401": {
                    "description": "Invalid credentials"
                  }
                }
              }
            },
            "/api/v1/auth/me": {
              "get": {
                "summary": "Get current user",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Current user info"
                  },
                  "401": {
                    "description": "Not authenticated"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Buffets Management",
        "description": "CRUD operations for law firms (buffets). Only admin can create/update/delete.",
        "files": [
          "src/modules/buffets/presentation/routers/buffet_router.py",
          "src/modules/buffets/application/use_cases/create_buffet.py",
          "src/modules/buffets/application/use_cases/get_buffet.py",
          "src/modules/buffets/application/use_cases/update_buffet.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "paths": {
            "/api/v1/buffets": {
              "get": {
                "summary": "List buffets with pagination",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "parameters": [
                  {
                    "name": "skip",
                    "in": "query",
                    "schema": {
                      "type": "integer",
                      "default": 0
                    }
                  },
                  {
                    "name": "limit",
                    "in": "query",
                    "schema": {
                      "type": "integer",
                      "default": 100
                    }
                  },
                  {
                    "name": "activo_only",
                    "in": "query",
                    "schema": {
                      "type": "boolean",
                      "default": true
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "List of buffets with pagination"
                  }
                }
              },
              "post": {
                "summary": "Create new buffet (admin only)",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "requestBody": {
                  "content": {
                    "application/json": {
                      "schema": {
                        "type": "object",
                        "required": [
                          "nombre",
                          "rut",
                          "email_principal"
                        ],
                        "properties": {
                          "nombre": {
                            "type": "string"
                          },
                          "rut": {
                            "type": "string"
                          },
                          "email_principal": {
                            "type": "string",
                            "format": "email"
                          },
                          "telefono": {
                            "type": "string"
                          },
                          "contacto_nombre": {
                            "type": "string"
                          }
                        }
                      }
                    }
                  }
                },
                "responses": {
                  "201": {
                    "description": "Buffet created"
                  },
                  "400": {
                    "description": "RUT already exists"
                  },
                  "403": {
                    "description": "Only admin can create buffets"
                  }
                }
              }
            },
            "/api/v1/buffets/{buffet_id}": {
              "get": {
                "summary": "Get buffet by ID",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "parameters": [
                  {
                    "name": "buffet_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Buffet details"
                  },
                  "404": {
                    "description": "Buffet not found"
                  }
                }
              },
              "put": {
                "summary": "Update buffet (admin only)",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "parameters": [
                  {
                    "name": "buffet_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Buffet updated"
                  },
                  "403": {
                    "description": "Only admin can update"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              },
              "delete": {
                "summary": "Delete buffet (soft delete, admin only)",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "parameters": [
                  {
                    "name": "buffet_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "204": {
                    "description": "Buffet deleted"
                  },
                  "403": {
                    "description": "Only admin can delete"
                  },
                  "404": {
                    "description": "Not found"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Oficios Management",
        "description": "Management of investigation orders (oficios). Includes vehicles, owners, addresses, and visit tracking.",
        "files": [
          "src/modules/oficios/presentation/routers/oficio_router.py",
          "src/modules/oficios/application/use_cases/create_oficio.py",
          "src/modules/oficios/application/use_cases/get_oficio.py",
          "src/modules/oficios/application/use_cases/registrar_visita.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "paths": {
            "/api/v1/oficios": {
              "get": {
                "summary": "List oficios with filters",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "parameters": [
                  {
                    "name": "skip",
                    "in": "query",
                    "schema": {
                      "type": "integer",
                      "default": 0
                    }
                  },
                  {
                    "name": "limit",
                    "in": "query",
                    "schema": {
                      "type": "integer",
                      "default": 20,
                      "maximum": 100
                    }
                  },
                  {
                    "name": "buffet_id",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  },
                  {
                    "name": "investigador_id",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  },
                  {
                    "name": "estado",
                    "in": "query",
                    "schema": {
                      "type": "string",
                      "enum": [
                        "pendiente",
                        "investigacion",
                        "notificacion",
                        "finalizado_encontrado",
                        "finalizado_no_encontrado"
                      ]
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "List of oficios"
                  }
                }
              },
              "post": {
                "summary": "Create new oficio",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "requestBody": {
                  "content": {
                    "application/json": {
                      "schema": {
                        "type": "object",
                        "required": [
                          "numero_oficio",
                          "buffet_id",
                          "patente"
                        ],
                        "properties": {
                          "numero_oficio": {
                            "type": "string"
                          },
                          "buffet_id": {
                            "type": "integer"
                          },
                          "patente": {
                            "type": "string"
                          },
                          "marca": {
                            "type": "string"
                          },
                          "modelo": {
                            "type": "string"
                          },
                          "año": {
                            "type": "integer"
                          },
                          "color": {
                            "type": "string"
                          },
                          "vin": {
                            "type": "string"
                          },
                          "prioridad": {
                            "type": "string",
                            "enum": [
                              "baja",
                              "media",
                              "alta",
                              "urgente"
                            ]
                          },
                          "fecha_limite": {
                            "type": "string",
                            "format": "date"
                          },
                          "notas_generales": {
                            "type": "string"
                          }
                        }
                      }
                    }
                  }
                },
                "responses": {
                  "201": {
                    "description": "Oficio created"
                  },
                  "400": {
                    "description": "Numero oficio already exists"
                  }
                }
              }
            },
            "/api/v1/oficios/{oficio_id}": {
              "get": {
                "summary": "Get oficio by ID with all related data",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "parameters": [
                  {
                    "name": "oficio_id",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "integer"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Oficio with vehiculos, propietarios, direcciones"
                  },
                  "404": {
                    "description": "Oficio not found"
                  }
                }
              }
            },
            "/api/v1/oficios/{oficio_id}/propietarios": {
              "post": {
                "summary": "Add owner to oficio",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "responses": {
                  "201": {
                    "description": "Propietario added"
                  }
                }
              }
            },
            "/api/v1/oficios/{oficio_id}/direcciones": {
              "post": {
                "summary": "Add address to oficio",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "responses": {
                  "201": {
                    "description": "Direccion added"
                  }
                }
              }
            },
            "/api/v1/oficios/direcciones/{direccion_id}/visitas": {
              "get": {
                "summary": "Get visit history for an address",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "responses": {
                  "200": {
                    "description": "List of visits"
                  }
                }
              },
              "post": {
                "summary": "Register a visit to an address",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "requestBody": {
                  "content": {
                    "application/json": {
                      "schema": {
                        "type": "object",
                        "required": [
                          "resultado"
                        ],
                        "properties": {
                          "resultado": {
                            "type": "string",
                            "enum": [
                              "pendiente",
                              "exitosa",
                              "no_encontrado",
                              "direccion_incorrecta",
                              "se_mudo",
                              "rechazo_atencion",
                              "otro"
                            ]
                          },
                          "notas": {
                            "type": "string",
                            "maxLength": 2000
                          },
                          "latitud": {
                            "type": "string"
                          },
                          "longitud": {
                            "type": "string"
                          }
                        }
                      }
                    }
                  }
                },
                "responses": {
                  "201": {
                    "description": "Visit registered"
                  },
                  "404": {
                    "description": "Address not found"
                  }
                }
              }
            },
            "/api/v1/oficios/{oficio_id}/direcciones/pendientes": {
              "get": {
                "summary": "Get pending addresses for verification",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "responses": {
                  "200": {
                    "description": "List of pending addresses"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Investigaciones Timeline",
        "description": "Timeline of activities and sightings for investigations.",
        "files": [
          "src/modules/investigaciones/presentation/routers/investigacion_router.py",
          "src/modules/investigaciones/application/use_cases/add_actividad.py",
          "src/modules/investigaciones/application/use_cases/add_avistamiento.py",
          "src/modules/investigaciones/application/use_cases/get_timeline.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "paths": {
            "/api/v1/oficios/{oficio_id}/timeline": {
              "get": {
                "summary": "Get investigation timeline",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Timeline with activities and sightings"
                  }
                }
              }
            },
            "/api/v1/oficios/{oficio_id}/actividades": {
              "post": {
                "summary": "Add activity to timeline",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "responses": {
                  "201": {
                    "description": "Activity added"
                  }
                }
              }
            },
            "/api/v1/oficios/{oficio_id}/avistamientos": {
              "post": {
                "summary": "Add vehicle sighting",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "responses": {
                  "201": {
                    "description": "Sighting recorded"
                  }
                }
              }
            }
          }
        }
      },
      {
        "name": "Boostr API Integration",
        "description": "External API integration for querying vehicle and person information from Chilean government databases.",
        "files": [
          "src/modules/investigaciones/presentation/routers/boostr_router.py",
          "src/shared/infrastructure/external_apis/boostr/client.py"
        ],
        "api_doc": {
          "openapi": "3.0.0",
          "paths": {
            "/api/v1/investigaciones/boostr/vehiculo/{patente}": {
              "get": {
                "summary": "Query vehicle by license plate",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "parameters": [
                  {
                    "name": "patente",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "string"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Vehicle information"
                  },
                  "404": {
                    "description": "Vehicle not found"
                  },
                  "429": {
                    "description": "Rate limit exceeded"
                  }
                }
              }
            },
            "/api/v1/investigaciones/boostr/vehiculo/{patente}/multas": {
              "get": {
                "summary": "Query traffic fines for vehicle",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "responses": {
                  "200": {
                    "description": "List of traffic fines"
                  }
                }
              }
            },
            "/api/v1/investigaciones/boostr/persona/{rut}": {
              "get": {
                "summary": "Query person by RUT (Chilean ID)",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "parameters": [
                  {
                    "name": "rut",
                    "in": "path",
                    "required": true,
                    "schema": {
                      "type": "string"
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Person information"
                  },
                  "400": {
                    "description": "Invalid RUT format"
                  },
                  "404": {
                    "description": "Person not found"
                  }
                }
              }
            },
            "/api/v1/investigaciones/boostr/persona/{rut}/vehiculos": {
              "get": {
                "summary": "Query vehicles owned by person",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "responses": {
                  "200": {
                    "description": "List of vehicles"
                  }
                }
              }
            },
            "/api/v1/investigaciones/boostr/investigar/vehiculo/{patente}": {
              "post": {
                "summary": "Complete vehicle investigation with optional oficio linkage",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "parameters": [
                  {
                    "name": "oficio_id",
                    "in": "query",
                    "schema": {
                      "type": "integer"
                    }
                  },
                  {
                    "name": "incluir_multas",
                    "in": "query",
                    "schema": {
                      "type": "boolean",
                      "default": true
                    }
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Complete vehicle investigation result"
                  }
                }
              }
            },
            "/api/v1/investigaciones/boostr/investigar/propietario/{rut}": {
              "post": {
                "summary": "Complete owner investigation with optional oficio linkage",
                "security": [
                  {
                    "bearerAuth": []
                  }
                ],
                "responses": {
                  "200": {
                    "description": "Complete owner investigation result"
                  }
                }
              }
            }
          }
        }
      }
    ]
  }
}
