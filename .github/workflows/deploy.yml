name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12.7'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      - name: Run Alembic migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          alembic upgrade head
        continue-on-error: true  # Continuar si falla (puede que ya est√©n aplicadas)

      - name: Run tests (optional)
        run: |
          pip install pytest pytest-asyncio pytest-cov
          pytest tests/ -v --tb=short || true
        continue-on-error: true

      - name: Build Docker image (optional)
        if: false  # Deshabilitado por ahora
        run: |
          docker build -t investigaciones-backend:latest .
        continue-on-error: true

      - name: Deploy to Render (opcional)
        if: ${{ secrets.RENDER_API_KEY != '' && secrets.RENDER_SERVICE_ID != '' }}
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "üöÄ Triggering deploy en Render..."
          curl -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": true}' || echo "‚ö†Ô∏è Deploy trigger fall√≥, pero el c√≥digo est√° actualizado en GitHub"
        continue-on-error: true

      - name: Verify deployment
        run: |
          echo "‚úÖ Build completado exitosamente"
          echo "üì¶ Dependencias instaladas correctamente"
          echo "üöÄ El c√≥digo est√° listo para desplegar"

